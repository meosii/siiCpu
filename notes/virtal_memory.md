# Virtal Memory 虚拟内存

## 为什么要使用虚拟内存？

虚拟内存的作用是让应用程序能够使用比物理内存更大的地址空间。这样，即使物理内存有限，也可以运行多个大型的应用程序。例如，假设有一个 32 位的处理器（内存大小最大为 2^32 B = 4GB），它的物理内存大小为 256MB，但是它要运行四个各占 128MB 的应用程序。如果没有虚拟内存，这是不可能的，因为物理内存不够。但是如果使用虚拟内存，每个应用程序都可以分配一个 4GB 的虚拟地址空间，这样它们就可以访问所有的数据和指令。操作系统负责将虚拟地址转换为物理地址，并在需要时将部分数据和指令从磁盘加载到物理内存中。这样，虚拟内存就提高了应用程序的性能和可移植性。

## 如何实现虚拟地址到物理地址的映射

虚拟地址到物理地址的映射是操作系统的一个重要功能，它可以让多个进程共享有限的物理内存，同时保护每个进程的地址空间不被其他进程干扰。虚拟地址到物理地址的映射通常由硬件和软件共同实现，其中硬件负责提供高速缓存（cache）和地址转换（address translation）的功能，软件负责管理虚拟内存（virtual memory）和页表（page table）的数据结构。

具体来说，当一个进程访问一个虚拟地址时，硬件会先检查缓存中是否有该地址对应的物理地址，如果有，则直接使用该物理地址访问内存，这称为缓存命中（cache hit）。如果没有，则硬件会根据页表中的信息，将虚拟地址分解为页号（page number）和页内偏移（page offset），然后根据页号找到对应的物理页框号（physical frame number），再将物理页框号和页内偏移组合成物理地址，这称为地址转换（address translation）。同时，硬件会将这个虚拟地址和物理地址的映射关系存入缓存中，以便下次访问时加快速度。

软件的作用是在缺页（page fault）发生时，为进程分配新的物理页框，并更新页表中的映射关系。缺页是指当一个进程访问一个虚拟地址时，发现该地址没有对应的物理页框，或者该地址所在的页面不在内存中，而是在磁盘上。这时，软件会从磁盘上读取该页面，并将其加载到内存中的一个空闲的物理页框中，然后修改页表中的映射关系，使得该虚拟地址指向新分配的物理页框。如果没有空闲的物理页框，则软件会采用一定的置换算法（replacement algorithm），选择一个已经在内存中的页面，将其写回磁盘，并释放其占用的物理页框，再用该物理页框来加载新页面。

以上面的例子为例，一个程序为 128MB，假设页的大小为 4MB，则该程序包含 32 个页；而物理内存的大小为 256MB，即 64 个页，即 64 个 PFN（Physical Frame Number）（PFN0 - PFN63）；而虚拟内存大小为 4GB，即 1024 个页（VPN0 - VPN1023）。也就是将 32 个页的程序，分布在 1024 个页的虚拟内存中，由映射关系，映射到 64 个页的物理内存中。有了对应物理页号后，偏移则与虚拟的偏移值相同，即得到了物理地址。

其中虚拟页号到物理页号的映射关系用一张表格来存储（page table），一般存放在物理内存中。而该页表在内存中的具体位置由页表寄存器（PTR）决定，因此在进行虚拟地址到物理地址的转换时，需要访问一次内存，得到映射关系后，计算得到物理地址，再对该物理地址进行访问。此时，读取一条指令需要访问两次内存，速度非常慢，因此，引入TLB。

TLB（Translation Lookaside Buffer）是页表的Cache，其中存储了当前最可能被访问到的页表项，其内容是部分页表项的一个副本。当CPU访问虚拟地址时，如果TLB中存在对应的物理地址，则直接返回物理地址；否则，需要通过查询页表来获取物理地址。